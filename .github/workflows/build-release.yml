# .github/workflows/build-release.yml
name: Build and Release NVX-Bridge

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Ref (branch, tag, or commit) of NVX-Bridge to build"
        required: true
        default: "main"
  push:
    tags:
      - "trigger-*"

permissions:
  contents: write

env:
  APP_REPO: ${{ secrets.NVX_APP_REPO }} 
  APP_MODULE: ${{ secrets.NVX_APP_MODULE }}
  APP_CMD: ./cmd/nvx-bridge
  GO_VERSION: "1.24.9"

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    outputs:
      git_sha: ${{ steps.clone.outputs.sha }}
    steps:
      - name: Checkout (release repo)
        uses: actions/checkout@v4

      - name: Prepare SSH for private clone
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.NVX_APP_SSH_KEY }}

      - name: Add GitHub to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - name: Clone NVX-Bridge
        id: clone
        run: |
          set -euo pipefail
          git clone --depth 1 --branch "${{ github.event.inputs.ref || 'main' }}" "$APP_REPO" app
          sha="$(cd app && git rev-parse --short=12 HEAD)"
          printf '%s\n' "$sha" > GIT_SHA.txt
          echo "sha=$sha" >> "$GITHUB_OUTPUT"

      - name: Install Linux deps (Gio)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc pkg-config \
            libwayland-dev \
            libx11-dev libx11-xcb-dev \
            libxkbcommon-dev libxkbcommon-x11-dev \
            libgles2-mesa-dev libegl1-mesa-dev \
            libffi-dev libxcursor-dev \
            libvulkan-dev

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache: true

      - name: Build
        working-directory: app
        env:
          CGO_ENABLED: "1"
          GOOS: linux
          GOARCH: amd64
        run: |
          go env
          go mod download
          mkdir -p dist
          go build -v -trimpath -ldflags "-s -w" -o dist/NVX-Bridge-linux-amd64 $APP_CMD

      - name: Stage package (Linux)
        shell: bash
        env:
          PKG_NAME: NVX-Bridge-linux-amd64
          ARCHIVE_NAME: NVX-Bridge-linux-amd64.tar.gz
          ARCHIVE_FORMAT: tar.gz
        run: |
          set -euo pipefail
          pkg_root="release/${PKG_NAME}"
          archive_dir="dist"
          rm -rf "$pkg_root"
          mkdir -p "$pkg_root" "$archive_dir"
          cp "app/dist/${PKG_NAME}" "$pkg_root/"
          chmod +x "$pkg_root/${PKG_NAME}"
          cp LICENSE NOTICE "$pkg_root/"
          rm -rf "$pkg_root/licenses"
          cp -R licenses "$pkg_root/"
          sha="$(cat GIT_SHA.txt)"
          printf 'NVX-Bridge commit: %s\n' "$sha" > "$pkg_root/REVISION.txt"
          python_bin="$(command -v python3 || true)"
          if [[ -z "$python_bin" ]]; then
            python_bin="$(command -v python || true)"
          fi
          if [[ -z "$python_bin" ]]; then
            echo "Python interpreter not found" >&2
            exit 1
          fi
          "$python_bin" tools/make_archive.py \
            --input-dir "$pkg_root" \
            --output "${archive_dir}/${ARCHIVE_NAME}" \
            --format "$ARCHIVE_FORMAT" \
            --sha256 "${archive_dir}/${ARCHIVE_NAME}.sha256"

      - name: Upload artifact (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: NVX-Bridge-linux-amd64
          path: |
            dist/NVX-Bridge-linux-amd64.tar.gz
            dist/NVX-Bridge-linux-amd64.tar.gz.sha256

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - name: Checkout (release repo)
        uses: actions/checkout@v4

      - name: Prepare SSH for private clone
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.NVX_APP_SSH_KEY }}

      - name: Add GitHub to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - name: Clone NVX-Bridge
        run: |
          set -euo pipefail
          git clone --depth 1 --branch "${{ github.event.inputs.ref || 'main' }}" "$APP_REPO" app
          sha="$(cd app && git rev-parse --short=12 HEAD)"
          printf '%s\n' "$sha" > GIT_SHA.txt

      - name: Ensure Command Line Tools
        run: |
          xcode-select -p || xcode-select --install || true

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache: true

      - name: Build (darwin amd64)
        working-directory: app
        env:
          CGO_ENABLED: "1"
          GOOS: darwin
          GOARCH: amd64
        run: |
          go env
          go mod download
          mkdir -p dist
          go build -v -trimpath -ldflags "-s -w" -o dist/NVX-Bridge-darwin-amd64 $APP_CMD

      - name: Stage package (macOS)
        shell: bash
        env:
          PKG_NAME: NVX-Bridge-darwin-amd64
          ARCHIVE_NAME: NVX-Bridge-darwin-amd64.tar.gz
          ARCHIVE_FORMAT: tar.gz
        run: |
          set -euo pipefail
          pkg_root="release/${PKG_NAME}"
          archive_dir="dist"
          rm -rf "$pkg_root"
          mkdir -p "$pkg_root" "$archive_dir"
          cp "app/dist/${PKG_NAME}" "$pkg_root/"
          chmod +x "$pkg_root/${PKG_NAME}"
          cp LICENSE NOTICE "$pkg_root/"
          rm -rf "$pkg_root/licenses"
          cp -R licenses "$pkg_root/"
          sha="$(cat GIT_SHA.txt)"
          printf 'NVX-Bridge commit: %s\n' "$sha" > "$pkg_root/REVISION.txt"
          python_bin="$(command -v python3 || true)"
          if [[ -z "$python_bin" ]]; then
            python_bin="$(command -v python || true)"
          fi
          if [[ -z "$python_bin" ]]; then
            echo "Python interpreter not found" >&2
            exit 1
          fi
          "$python_bin" tools/make_archive.py \
            --input-dir "$pkg_root" \
            --output "${archive_dir}/${ARCHIVE_NAME}" \
            --format "$ARCHIVE_FORMAT" \
            --sha256 "${archive_dir}/${ARCHIVE_NAME}.sha256"

      - name: Upload artifact (macOS)
        uses: actions/upload-artifact@v4
        with:
          name: NVX-Bridge-darwin-amd64
          path: |
            dist/NVX-Bridge-darwin-amd64.tar.gz
            dist/NVX-Bridge-darwin-amd64.tar.gz.sha256

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout (release repo)
        uses: actions/checkout@v4

      - name: Prepare SSH for private clone
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.NVX_APP_SSH_KEY }}

      - name: Add GitHub to known_hosts
        shell: bash
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - name: Clone NVX-Bridge
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth 1 --branch "${{ github.event.inputs.ref || 'main' }}" "$APP_REPO" app
          sha="$(cd app && git rev-parse --short=12 HEAD)"
          printf '%s\n' "$sha" > GIT_SHA.txt

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache: true

      - name: Build (windows amd64)
        working-directory: app
        shell: bash
        env:
          CGO_ENABLED: "1"
          GOOS: windows
          GOARCH: amd64
        run: |
          go env
          go mod download
          mkdir -p dist
          go build -v -trimpath -ldflags "-s -w -H=windowsgui" -o dist/NVX-Bridge-windows-amd64.exe $APP_CMD

      - name: Stage package (Windows)
        shell: bash
        env:
          PKG_NAME: NVX-Bridge-windows-amd64
          ARCHIVE_NAME: NVX-Bridge-windows-amd64.zip
          ARCHIVE_FORMAT: zip
        run: |
          set -euo pipefail
          pkg_root="release/${PKG_NAME}"
          archive_dir="dist"
          rm -rf "$pkg_root"
          mkdir -p "$pkg_root" "$archive_dir"
          cp "app/dist/${PKG_NAME}.exe" "$pkg_root/${PKG_NAME}.exe"
          cp LICENSE NOTICE "$pkg_root/"
          rm -rf "$pkg_root/licenses"
          cp -R licenses "$pkg_root/"
          sha="$(cat GIT_SHA.txt)"
          printf 'NVX-Bridge commit: %s\n' "$sha" > "$pkg_root/REVISION.txt"
          python_bin="$(command -v python3 || true)"
          if [[ -z "$python_bin" ]]; then
            python_bin="$(command -v python || true)"
          fi
          if [[ -z "$python_bin" ]]; then
            echo "Python interpreter not found" >&2
            exit 1
          fi
          "$python_bin" tools/make_archive.py \
            --input-dir "$pkg_root" \
            --output "${archive_dir}/${ARCHIVE_NAME}" \
            --format "$ARCHIVE_FORMAT" \
            --sha256 "${archive_dir}/${ARCHIVE_NAME}.sha256"

      - name: Upload artifact (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: NVX-Bridge-windows-amd64
          path: |
            dist/NVX-Bridge-windows-amd64.zip
            dist/NVX-Bridge-windows-amd64.zip.sha256

  publish:
    name: Draft GitHub Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos, build-windows]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Compose release tag and name
        id: meta
        env:
          BUILD_SHA: ${{ needs.build-linux.outputs.git_sha }}
        run: |
          DATE_TAG=$(date -u +'%Y.%m.%d')
          echo "date_tag=$DATE_TAG" >> "$GITHUB_OUTPUT"
          SHA="${BUILD_SHA:-unknown}"
          if [ -z "$SHA" ]; then
            SHA="unknown"
          fi
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          echo "tag=v${DATE_TAG}-${SHA}" >> "$GITHUB_OUTPUT"
          echo "name=NVX-Bridge ${DATE_TAG} (${SHA})" >> "$GITHUB_OUTPUT"

      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.name }}
          draft: true
          generate_release_notes: true
          files: |
            artifacts/NVX-Bridge-linux-amd64/dist/NVX-Bridge-linux-amd64.tar.gz
            artifacts/NVX-Bridge-linux-amd64/dist/NVX-Bridge-linux-amd64.tar.gz.sha256
            artifacts/NVX-Bridge-darwin-amd64/dist/NVX-Bridge-darwin-amd64.tar.gz
            artifacts/NVX-Bridge-darwin-amd64/dist/NVX-Bridge-darwin-amd64.tar.gz.sha256
            artifacts/NVX-Bridge-windows-amd64/dist/NVX-Bridge-windows-amd64.zip
            artifacts/NVX-Bridge-windows-amd64/dist/NVX-Bridge-windows-amd64.zip.sha256
