# .github/workflows/build-release.yml
name: Build and Release NVX-Bridge

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Ref (branch, tag, or commit) of NVX-Bridge to build"
        required: true
        default: "main"
  push:
    tags:
      - "trigger-*"

permissions:
  contents: write

env:
  APP_REPO: ${{ secrets.NVX_APP_REPO }} 
  APP_MODULE: ${{ secrets.NVX_APP_MODULE }}
  APP_CMD: ./cmd/nvx-bridge
  GO_VERSION: "1.24.9"

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (release repo)
        uses: actions/checkout@v4

      - name: Prepare SSH for private clone
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.NVX_APP_SSH_KEY }}

      - name: Add GitHub to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - name: Clone NVX-Bridge
        run: |
          git clone --depth 1 --branch "${{ github.event.inputs.ref || 'main' }}" "$APP_REPO" app
          cd app && git rev-parse --short HEAD > ../GIT_SHA.txt

      - name: Install Linux deps (Gio)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc pkg-config \
            libwayland-dev \
            libx11-dev libx11-xcb-dev \
            libxkbcommon-dev libxkbcommon-x11-dev \
            libgles2-mesa-dev libegl1-mesa-dev \
            libffi-dev libxcursor-dev \
            libvulkan-dev

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache: true

      - name: Build
        working-directory: app
        env:
          CGO_ENABLED: "1"
          GOOS: linux
          GOARCH: amd64
        run: |
          go env
          go mod download
          go build -v -trimpath -ldflags "-s -w" -o dist/NVX-Bridge-linux-amd64 $APP_CMD
          sha256sum dist/NVX-Bridge-linux-amd64 | tee ../SHA256SUMS-linux.txt

      - name: Upload artifact (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: NVX-Bridge-linux-amd64
          path: |
            app/dist/NVX-Bridge-linux-amd64
            SHA256SUMS-linux.txt

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - name: Checkout (release repo)
        uses: actions/checkout@v4

      - name: Prepare SSH for private clone
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.NVX_APP_SSH_KEY }}

      - name: Add GitHub to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - name: Clone NVX-Bridge
        run: |
          git clone --depth 1 --branch "${{ github.event.inputs.ref || 'main' }}" "$APP_REPO" app
          cd app && git rev-parse --short HEAD > ../GIT_SHA.txt

      - name: Ensure Command Line Tools
        run: |
          xcode-select -p || xcode-select --install || true

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache: true

      - name: Build (darwin amd64)
        working-directory: app
        env:
          CGO_ENABLED: "1"
          GOOS: darwin
          GOARCH: amd64
        run: |
          go env
          go mod download
          go build -v -trimpath -ldflags "-s -w" -o dist/NVX-Bridge-darwin-amd64 $APP_CMD
          shasum -a 256 dist/NVX-Bridge-darwin-amd64 | tee ../SHA256SUMS-darwin.txt

      - name: Upload artifact (macOS)
        uses: actions/upload-artifact@v4
        with:
          name: NVX-Bridge-darwin-amd64
          path: |
            app/dist/NVX-Bridge-darwin-amd64
            SHA256SUMS-darwin.txt

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout (release repo)
        uses: actions/checkout@v4

      - name: Prepare SSH for private clone
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.NVX_APP_SSH_KEY }}

      - name: Add GitHub to known_hosts
        shell: bash
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - name: Clone NVX-Bridge
        shell: bash
        run: |
          git clone --depth 1 --branch "${{ github.event.inputs.ref || 'main' }}" "$APP_REPO" app
          cd app && git rev-parse --short HEAD > ../GIT_SHA.txt

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache: true

      - name: Build (windows amd64)
        working-directory: app
        shell: bash
        env:
          CGO_ENABLED: "1"
          GOOS: windows
          GOARCH: amd64
        run: |
          go env
          go mod download
          go build -v -trimpath -ldflags "-s -w -H=windowsgui" -o dist/NVX-Bridge-windows-amd64.exe $APP_CMD
          sha256sum dist/NVX-Bridge-windows-amd64.exe | tee ../SHA256SUMS-windows.txt

      - name: Upload artifact (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: NVX-Bridge-windows-amd64
          path: |
            app/dist/NVX-Bridge-windows-amd64.exe
            SHA256SUMS-windows.txt

  publish:
    name: Draft GitHub Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos, build-windows]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Compose release tag and name
        id: meta
        run: |
          DATE_TAG=$(date -u +'%Y.%m.%d')
          echo "date_tag=$DATE_TAG" >> $GITHUB_OUTPUT
          # Prefer the Linux build SHA if present
          SHA=$(cat artifacts/NVX-Bridge-linux-amd64/../../GIT_SHA.txt 2>/dev/null || echo "unknown")
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "tag=v${DATE_TAG}-${SHA}" >> $GITHUB_OUTPUT
          echo "name=NVX-Bridge ${DATE_TAG} (${SHA})" >> $GITHUB_OUTPUT

      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.name }}
          draft: true
          generate_release_notes: true
          files: |
            artifacts/NVX-Bridge-linux-amd64/NVX-Bridge-linux-amd64
            artifacts/NVX-Bridge-linux-amd64/SHA256SUMS-linux.txt
            artifacts/NVX-Bridge-darwin-amd64/NVX-Bridge-darwin-amd64
            artifacts/NVX-Bridge-darwin-amd64/SHA256SUMS-darwin.txt
            artifacts/NVX-Bridge-windows-amd64/NVX-Bridge-windows-amd64.exe
            artifacts/NVX-Bridge-windows-amd64/SHA256SUMS-windows.txt
