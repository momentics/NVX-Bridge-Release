# .github/workflows/build-release.yml
name: Build and Release NVX-Bridge

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Ref (branch, tag, or commit) of NVX-Bridge to build"
        required: true
        default: "main"
  push:
    tags:
      - "trigger-*"

permissions:
  contents: write

env:
  APP_REPO: ${{ secrets.NVX_APP_REPO }} 
  APP_MODULE: ${{ secrets.NVX_APP_MODULE }}
  APP_CMD: ./cmd/nvx-bridge
  GO_VERSION: "1.24.9"

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    outputs:
      git_sha: ${{ steps.clone.outputs.sha }}
    steps:
      - name: Checkout (release repo)
        uses: actions/checkout@v4

      - name: Prepare SSH for private clone
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.NVX_APP_SSH_KEY }}

      - name: Add GitHub to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - name: Clone NVX-Bridge
        id: clone
        run: |
          set -euo pipefail
          git clone --depth 1 --branch "${{ github.event.inputs.ref || 'main' }}" "$APP_REPO" app
          sha="$(cd app && git rev-parse --short=12 HEAD)"
          printf '%s\n' "$sha" > GIT_SHA.txt
          echo "sha=$sha" >> "$GITHUB_OUTPUT"

      - name: Install Linux deps (Gio)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc pkg-config \
            libwayland-dev \
            libx11-dev libx11-xcb-dev \
            libxkbcommon-dev libxkbcommon-x11-dev \
            libgles2-mesa-dev libegl1-mesa-dev \
            libffi-dev libxcursor-dev \
            libvulkan-dev

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache: true

      - name: Build
        working-directory: app
        env:
          CGO_ENABLED: "1"
          GOOS: linux
          GOARCH: amd64
        run: |
          go env
          go mod download
          mkdir -p dist
          go build -v -trimpath -ldflags "-s -w" -o dist/NVX-Bridge-linux-amd64 $APP_CMD

      - name: Stage package (Linux)
        shell: bash
        env:
          PKG_NAME: NVX-Bridge-linux-amd64
          ARCHIVE_NAME: NVX-Bridge-linux-amd64.tar.gz
        run: |
          set -euo pipefail
          pkg_root="release/${PKG_NAME}"
          archive_dir="dist"
          rm -rf "$pkg_root"
          mkdir -p "$pkg_root" "$archive_dir"
          cp "app/dist/${PKG_NAME}" "$pkg_root/"
          chmod +x "$pkg_root/${PKG_NAME}"
          cp LICENSE NOTICE "$pkg_root/"
          rm -rf "$pkg_root/licenses"
          cp -R licenses "$pkg_root/"
          sha="$(cat GIT_SHA.txt)"
          printf 'NVX-Bridge commit: %s\n' "$sha" > "$pkg_root/REVISION.txt"
          tar -czf "${archive_dir}/${ARCHIVE_NAME}" -C release "${PKG_NAME}"
          sha256sum "${archive_dir}/${ARCHIVE_NAME}" > "${archive_dir}/${ARCHIVE_NAME}.sha256"

      - name: Upload artifact (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: NVX-Bridge-linux-amd64
          path: |
            dist/NVX-Bridge-linux-amd64.tar.gz
            dist/NVX-Bridge-linux-amd64.tar.gz.sha256

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - name: Checkout (release repo)
        uses: actions/checkout@v4

      - name: Prepare SSH for private clone
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.NVX_APP_SSH_KEY }}

      - name: Add GitHub to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - name: Clone NVX-Bridge
        run: |
          set -euo pipefail
          git clone --depth 1 --branch "${{ github.event.inputs.ref || 'main' }}" "$APP_REPO" app
          sha="$(cd app && git rev-parse --short=12 HEAD)"
          printf '%s\n' "$sha" > GIT_SHA.txt

      - name: Ensure Command Line Tools
        run: |
          xcode-select -p || xcode-select --install || true

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache: true

      - name: Build (darwin amd64)
        working-directory: app
        env:
          CGO_ENABLED: "1"
          GOOS: darwin
          GOARCH: amd64
        run: |
          go env
          go mod download
          mkdir -p dist
          go build -v -trimpath -ldflags "-s -w" -o dist/NVX-Bridge-darwin-amd64 $APP_CMD

      - name: Stage package (macOS)
        shell: bash
        env:
          PKG_NAME: NVX-Bridge-darwin-amd64
          ARCHIVE_NAME: NVX-Bridge-darwin-amd64.tar.gz
        run: |
          set -euo pipefail
          pkg_root="release/${PKG_NAME}"
          archive_dir="dist"
          rm -rf "$pkg_root"
          mkdir -p "$pkg_root" "$archive_dir"
          cp "app/dist/${PKG_NAME}" "$pkg_root/"
          chmod +x "$pkg_root/${PKG_NAME}"
          cp LICENSE NOTICE "$pkg_root/"
          rm -rf "$pkg_root/licenses"
          cp -R licenses "$pkg_root/"
          sha="$(cat GIT_SHA.txt)"
          printf 'NVX-Bridge commit: %s\n' "$sha" > "$pkg_root/REVISION.txt"
          tar -czf "${archive_dir}/${ARCHIVE_NAME}" -C release "${PKG_NAME}"
          shasum -a 256 "${archive_dir}/${ARCHIVE_NAME}" > "${archive_dir}/${ARCHIVE_NAME}.sha256"

      - name: Upload artifact (macOS)
        uses: actions/upload-artifact@v4
        with:
          name: NVX-Bridge-darwin-amd64
          path: |
            dist/NVX-Bridge-darwin-amd64.tar.gz
            dist/NVX-Bridge-darwin-amd64.tar.gz.sha256

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout (release repo)
        uses: actions/checkout@v4

      - name: Prepare SSH for private clone
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.NVX_APP_SSH_KEY }}

      - name: Add GitHub to known_hosts
        shell: bash
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - name: Clone NVX-Bridge
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth 1 --branch "${{ github.event.inputs.ref || 'main' }}" "$APP_REPO" app
          sha="$(cd app && git rev-parse --short=12 HEAD)"
          printf '%s\n' "$sha" > GIT_SHA.txt

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache: true

      - name: Build (windows amd64)
        working-directory: app
        shell: bash
        env:
          CGO_ENABLED: "1"
          GOOS: windows
          GOARCH: amd64
        run: |
          go env
          go mod download
          mkdir -p dist
          go build -v -trimpath -ldflags "-s -w -H=windowsgui" -o dist/NVX-Bridge-windows-amd64.exe $APP_CMD

      - name: Stage package (Windows)
        shell: pwsh
        env:
          PKG_NAME: NVX-Bridge-windows-amd64
          ARCHIVE_NAME: NVX-Bridge-windows-amd64.zip
        run: |
          $pkgRoot = Join-Path release $env:PKG_NAME
          $archiveDir = "dist"
          Remove-Item $pkgRoot -Recurse -Force -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path $pkgRoot | Out-Null
          $archiveDirObj = New-Item -ItemType Directory -Force -Path $archiveDir
          Copy-Item "app/dist/$($env:PKG_NAME).exe" -Destination "$pkgRoot/$($env:PKG_NAME).exe"
          Copy-Item -Path LICENSE, NOTICE -Destination $pkgRoot
          Remove-Item "$pkgRoot/licenses" -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item -Path licenses -Destination $pkgRoot -Recurse
          $sha = (Get-Content GIT_SHA.txt -Raw).Trim()
          "NVX-Bridge commit: $sha" | Set-Content "$pkgRoot/REVISION.txt"
          $archivePath = Join-Path $archiveDirObj.FullName $env:ARCHIVE_NAME
          Push-Location release
          Compress-Archive -Path $env:PKG_NAME -DestinationPath $archivePath -Force
          Pop-Location
          $hash = Get-FileHash -Algorithm SHA256 $archivePath
          "$($hash.Hash.ToLower())  $($env:ARCHIVE_NAME)" | Set-Content "$archivePath.sha256"

      - name: Upload artifact (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: NVX-Bridge-windows-amd64
          path: |
            dist/NVX-Bridge-windows-amd64.zip
            dist/NVX-Bridge-windows-amd64.zip.sha256

  publish:
    name: Draft GitHub Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos, build-windows]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Gather release assets
        run: |
          set -euo pipefail
          assets_dir="release-assets"
          mkdir -p "$assets_dir"

          copy_asset() {
            local artifact_dir="$1"
            local filename="$2"
            local dest_name="${3:-$2}"
            local found
            found="$(find "$artifact_dir" -type f -name "$filename" -print -quit || true)"
            if [ -z "$found" ]; then
              echo "Failed to locate $filename inside $artifact_dir" >&2
              exit 1
            fi
            cp "$found" "$assets_dir/$dest_name"
          }

          copy_asset "artifacts/NVX-Bridge-linux-amd64" "NVX-Bridge-linux-amd64.tar.gz"
          copy_asset "artifacts/NVX-Bridge-linux-amd64" "NVX-Bridge-linux-amd64.tar.gz.sha256"
          copy_asset "artifacts/NVX-Bridge-darwin-amd64" "NVX-Bridge-darwin-amd64.tar.gz"
          copy_asset "artifacts/NVX-Bridge-darwin-amd64" "NVX-Bridge-darwin-amd64.tar.gz.sha256"
          copy_asset "artifacts/NVX-Bridge-windows-amd64" "NVX-Bridge-windows-amd64.zip"
          copy_asset "artifacts/NVX-Bridge-windows-amd64" "NVX-Bridge-windows-amd64.zip.sha256"

      - name: Compose release tag and name
        id: meta
        env:
          BUILD_SHA: ${{ needs.build-linux.outputs.git_sha }}
        run: |
          DATE_TAG=$(date -u +'%Y.%m.%d')
          echo "date_tag=$DATE_TAG" >> "$GITHUB_OUTPUT"
          SHA="${BUILD_SHA:-unknown}"
          if [ -z "$SHA" ]; then
            SHA="unknown"
          fi
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          echo "tag=v${DATE_TAG}-${SHA}" >> "$GITHUB_OUTPUT"
          echo "name=NVX-Bridge ${DATE_TAG} (${SHA})" >> "$GITHUB_OUTPUT"

      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.name }}
          draft: true
          generate_release_notes: true
          files: |
            release-assets/NVX-Bridge-linux-amd64.tar.gz
            release-assets/NVX-Bridge-linux-amd64.tar.gz.sha256
            release-assets/NVX-Bridge-darwin-amd64.tar.gz
            release-assets/NVX-Bridge-darwin-amd64.tar.gz.sha256
            release-assets/NVX-Bridge-windows-amd64.zip
            release-assets/NVX-Bridge-windows-amd64.zip.sha256

      - name: Remove automatic release attestation asset
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          tag='${{ steps.meta.outputs.tag }}'
          release_json="$(gh api "repos/${{ github.repository }}/releases/tags/${tag}")"
          release_id="$(printf '%s' "$release_json" | jq -r '.id')"
          if [[ -z "$release_id" || "$release_id" == "null" ]]; then
            echo "Release not found, skipping attestation cleanup"
            exit 0
          fi
          gh api "repos/${{ github.repository }}/releases/${release_id}/assets" --jq '.[] | select(.name | test("(?i)attestation")) | .id' | while read -r asset_id; do
            if [[ -n "$asset_id" ]]; then
              echo "Deleting attestation asset $asset_id"
              gh api --method DELETE "repos/${{ github.repository }}/releases/assets/${asset_id}"
            fi
          done
